/*!
 * jQuery Plugin WebCodeCam-0.0.1 
 * Author: Tóth András 2014-11-01
 * Web: http://atandrastoth.co.uk
 * email: atandrastoth@gmail.com
 * Licensed under the MIT license
 */

/*
Included:
barcode decoder (DecoderWorker.js) -> https://github.com/EddieLa/BarcodeReader/blob/master/src/DecoderWorker.js
qr-decoder (qrcodelib.js) -> https://github.com/LazarSoft/jsqrcode
*/
(function(m,s,H,I){function B(a,e){this.element=a;d=m(a);this.options=m.extend({},C,e);this._defaults=C;this._name="WebCodeCam";this.initCamera()&&(this.setEventListeners(),(this.options.ReadQRCode||this.options.ReadBarecode)&&this.setCallback())}var f=m('<video style="position:absolute;visibility:hidden;display: none;">')[0],n,r=!1,D=!1,k,d,g,h,E=new Worker("js/DecoderWorker.js"),l=!1,C={ReadQRCode:!0,ReadBarecode:!0,width:320,height:240,flipVertical:!1,flipHorizontal:!1,zoom:-1,beep:"js/beep.mp3",
brightness:0,autoBrightnessValue:false,grayScale:!1,contrast:0,threshold:0,sharpness:[],resultFunction:function(a,e){}};B.prototype={initCamera:function(){k=this.element.getContext("2d");g=this.options.width;h=this.options.height;navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;if(navigator.getUserMedia)navigator.getUserMedia({video:!0,audio:!1},function(a){var e=s.URL||s.webkitURL;f.src=e?e.createObjectURL(a):a;f.play()},
function(a){alert("Something went wrong. (error code "+a.code+")");return!1});else return alert("Sorry, the browser you are using doesn't support getUserMedia"),!1;return!0},setEventListeners:function(){f.addEventListener("canplay",function(a){D||(0<f.videoWidth&&(h=f.videoHeight/(f.videoWidth/g)),d[0].setAttribute("width",g),d[0].setAttribute("height",h),d.data().plugin_WebCodeCam.options.flipHorizontal&&(k.scale(-1,1),k.translate(-g,0)),d.data().plugin_WebCodeCam.options.flipVertical&&(k.scale(1,
-1),k.translate(0,-h)),D=!0,(d.data().plugin_WebCodeCam.options.ReadQRCode||d.data().plugin_WebCodeCam.options.ReadBarecode)&&d.data().plugin_WebCodeCam.delay())},!1);f.addEventListener("play",function(){setInterval(function(){if(!f.paused&&!f.ended){k.clearRect(0,0,g,h);var a=d.data().plugin_WebCodeCam.options.zoom;0>a&&(a=d.data().plugin_WebCodeCam.optimalZoom());k.drawImage(f,(g*a-g)/-2,(h*a-h)/-2,g*a,h*a);var a=k.getImageData(0,0,g,h),e=d.data().plugin_WebCodeCam.options.brightness,b=d.data().plugin_WebCodeCam.options.grayScale,
c=d.data().plugin_WebCodeCam.options.threshold,F=d.data().plugin_WebCodeCam.options.sharpness,G=d.data().plugin_WebCodeCam.options.contrast,x=d.data().plugin_WebCodeCam.options.autoBrightnessValue;b&&(a=d.data().plugin_WebCodeCam.grayScale(a));if(0!=e||0!=x)a=d.data().plugin_WebCodeCam.brightness(a,e);0!=G&&(a=d.data().plugin_WebCodeCam.contrast(a,G));0!=c&&(a=d.data().plugin_WebCodeCam.threshold(a,c));0!=F.length&&(a=d.data().plugin_WebCodeCam.convolute(a,F));k.putImageData(a,0,0)}},40)},!1)},setCallback:function(){E.onmessage=
function(a){l||f.paused||(a.data.success&&1<a.data.result[0].length&&a.data.result[0]!=I?(l=!0,d.data().plugin_WebCodeCam.delay(),d.data().plugin_WebCodeCam.beep(),d.data().plugin_WebCodeCam.options.resultFunction(a.data.result[0],n)):a.data.finished&&(r=!r,setTimeout(function(){d.data().plugin_WebCodeCam.tryParseBarecode()},200)))};qrcode.callback=function(a){l||f.paused||(l=!0,d.data().plugin_WebCodeCam.delay(),d.data().plugin_WebCodeCam.beep(),d.data().plugin_WebCodeCam.options.resultFunction(a,
n))}},tryParseBarecode:function(){var a=1==r?"flip":"normal";n=d[0].toDataURL();var e=k.getImageData(0,0,g,h).data;E.postMessage({ImageData:e,Width:g,Height:h,cmd:a,DecodeNr:1,LowLight:!1})},tryParseQRCode:function(){try{n=d[0].toDataURL(),qrcode.decode()}catch(a){setTimeout(function(){d.data().plugin_WebCodeCam.tryParseQRCode()},400)}},delay:function(){d.data().plugin_WebCodeCam.cameraPlay()},cameraStop:function(){l=!0;f.pause()},cameraPlay:function(){l=!0;f.play();setTimeout(function(){l=!1;d.data().plugin_WebCodeCam.options.ReadBarecode&&
d.data().plugin_WebCodeCam.tryParseBarecode();d.data().plugin_WebCodeCam.options.ReadQRCode&&d.data().plugin_WebCodeCam.tryParseQRCode()},1E3)},getLastImageSrc:function(){return n},optimalZoom:function(a){return f.videoHeight/h},getImageLightness:function(){pixels=k.getImageData(0,0,g,h);for(var a=pixels.data,e=0,b,c,d,f=0,x=a.length;f<x;f+=4)b=a[f],c=a[f+1],d=a[f+2],b=Math.floor((b+c+d)/3),e+=b;return Math.floor(e/(g*h))},brightness:function(a,e){e=0==e&&0!=this.options.autoBrightnessValue?this.options.autoBrightnessValue-
this.getImageLightness():e;for(var b=a.data,c=0;c<b.length;c+=4)b[c]+=e,b[c+1]+=e,b[c+2]+=e;return a},grayScale:function(a){for(var e=a.data,b=0;b<e.length;b+=4)e[b]=e[b+1]=e[b+2]=.2126*e[b]+.7152*e[b+1]+.0722*e[b+2];return a},contrast:function(a,e){for(var b=a.data,c=0;c<b.length;c+=4){e=10;var d=Math.round((b[c]+b[c+1]+b[c+2])/3);127<d?(b[c]+=b[c]/d*e,b[c+1]+=b[c+1]/d*e,b[c+2]+=b[c+2]/d*e):(b[c]-=b[c]/d*e,b[c+1]-=b[c+1]/d*e,b[c+2]-=b[c+2]/d*e)}return a},threshold:function(a,d){for(var b=a.data,
c=0,f=g*h*4;c<f;c+=4)ave=b[c]+b[c+1]+b[c+2],b[c]=ave<d?b[c+1]=b[c+2]=0:b[c+1]=b[c+2]=255,b[c+3]=255;return a},convolute:function(a,d,b){var c=Math.round(Math.sqrt(d.length)),f=Math.floor(c/2),h=a.data,g=a.width;a=a.height;var k=H.createElement("canvas").getContext("2d").createImageData(g,a),l=k.data;b=b?1:0;for(var m=0;m<a;m++)for(var n=0;n<g;n++){for(var r=m,s=n,t=4*(m*g+n),y=0,z=0,A=0,u=0,v=0;v<c;v++)for(var w=0;w<c;w++){var p=r+v-f,q=s+w-f;0<=p&&p<a&&0<=q&&q<g&&(p=4*(p*g+q),q=d[v*c+w],y+=h[p]*
q,z+=h[p+1]*q,A+=h[p+2]*q,u+=h[p+3]*q)}l[t]=y;l[t+1]=z;l[t+2]=A;l[t+3]=u+b*(255-u)}return k},beep:function(){"string"==typeof this.options.beep&&(new Audio(this.options.beep)).play()}};m.fn.WebCodeCam=function(a){return this.each(function(){m.data(this,"plugin_WebCodeCam")||m.data(this,"plugin_WebCodeCam",new B(this,a))})}})(jQuery,window,document);